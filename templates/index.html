<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<style>
  body{font-family:Arial,sans-serif;margin:30px;}
  .tabs{display:flex;gap:8px;margin-bottom:12px;}
  .tabs button{padding:8px 14px;border:1px solid #ccc;background:#f7f7f7;cursor:pointer}
  .tabs button.active{background:#4CAF50;color:#fff;border-color:#4CAF50}
  .tab{display:none}.tab.active{display:block}
  .msg{padding:8px;margin:10px 0;border-radius:6px;background:#e7f6ec;border:1px solid #b7e1c4}
  .msg.err{background:#fdecea;border-color:#f5c2c0}
  .logs{background:#111;color:#ddd;padding:10px;border-radius:6px;font-family:monospace;white-space:pre-wrap}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:6px;border-bottom:1px solid #ddd;text-align:left}
  label{display:block;margin-top:8px}
  input,select,textarea{width:100%;padding:8px;margin-top:4px}
  button{padding:8px 14px;margin-top:8px}
  .muted{color:#666;font-size:12px}
</style>
</head>
<body>
<h1>–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å</h1>

{% with messages=get_flashed_messages() %}
  {% for m in messages %}<div class="msg">{{ m }}</div>{% endfor %}
{% endwith %}

<div class="tabs">
  <button class="tabbtn active" data-target="#tab-milk">üßæ –í–≤–æ–¥ –≤ –æ–±–æ—Ä–æ—Ç</button>
  <button class="tabbtn" data-target="#tab-move">üîÑ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ</button>
</div>

<!-- –í–ö–õ–ê–î–ö–ê 1: –ú–û–õ–û–ß–ù–´–ô JSON -->
<div id="tab-milk" class="tab active">
  <h2>–í–≤–æ–¥ –≤ –æ–±–æ—Ä–æ—Ç (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è XML/CSV –∏–∑ JSON)</h2>

  <form method="POST" action="{{ url_for('milk_upload_json') }}" enctype="multipart/form-data">
    <label>–ó–∞–≥—Ä—É–∑–∏—Ç–µ JSON:</label>
    <input type="file" name="json_file" required>
    <button type="submit">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
  </form>

  {% if state.milk_parsed %}
    <h3>–†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>
    <div class="logs">{{ state.milk_parsed | tojson(indent=2, ensure_ascii=False) }}</div>

    <h3>–ö–æ–¥—ã –∏ –≤—ã–≥—Ä—É–∑–∫–∞</h3>
    <form method="POST" action="{{ url_for('download_csv') }}">
      <label>–ò–º—è —Ñ–∞–π–ª–∞ (CSV):</label>
      <input type="text" name="file_name" value="codes">
      <label>–ö–æ–¥—ã (–æ–¥–∏–Ω –Ω–∞ —Å—Ç—Ä–æ–∫—É, –º–æ–∂–Ω–æ c &lt;GS&gt;):</label>
      <textarea name="codes" rows="8"></textarea>
      <button type="submit">–°–∫–∞—á–∞—Ç—å CSV</button>
    </form>

    <form method="POST" action="{{ url_for('download_xml') }}">
      <input type="hidden" name="file_name" value="file">
      <label>–ö–æ–¥—ã (–¥–ª—è XML, –º–æ–∂–Ω–æ —Ç–µ –∂–µ):</label>
      <textarea name="codes" rows="8"></textarea>
      <button type="submit">–°–∫–∞—á–∞—Ç—å XML</button>
    </form>
  {% endif %}
</div>

<!-- –í–ö–õ–ê–î–ö–ê 2: –ü–ï–†–ï–ú–ï–©–ï–ù–ò–ï -->
<div id="tab-move" class="tab">
  <h2>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ XML –∏ –∑–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞</h2>

  <form method="POST" action="{{ url_for('upload_xmls') }}" enctype="multipart/form-data">
    <label>XML #1:</label>
    <input type="file" name="xml1" accept=".xml" required>
    <label>XML #2:</label>
    <input type="file" name="xml2" accept=".xml" required>
    <button type="submit">–°—Ä–∞–≤–Ω–∏—Ç—å</button>
  </form>

  {% if state.xml1_name and state.xml2_name %}
    <p>–ó–∞–≥—Ä—É–∂–µ–Ω–æ: <b>{{ state.xml1_name }}</b> –∏ <b>{{ state.xml2_name }}</b></p>

    {% if state.codes_equal %}
      <div class="msg">‚úÖ –ö–æ–¥—ã —Å–æ–≤–ø–∞–¥–∞—é—Ç. –ù–∞–π–¥–µ–Ω–æ doc_num=<b>{{ state.doc_num_xml }}</b>, doc_date=<b>{{ state.doc_date_xml }}</b></div>

      <h3>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—É—Å–∫–∞</h3>
      <form method="POST" action="{{ url_for('run_flow_route') }}">
        <label>–ú–î –ø–µ—Ä–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞:</label><input type="text" name="md1" required>
        <span class="muted">–Ω–∞–ø—Ä–∏–º–µ—Ä, 27 (–ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –≤–æ–∑—å–º—É—Ç—Å—è –∏–∑ varables/accounts.json)</span>

        <label>–ú–î –≤—Ç–æ—Ä–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞:</label><input type="text" name="md2" required>

        <label>–ù–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞ (invoice):</label>
        <input type="text" name="invoice" value="{{ state.doc_num_xml or '' }}" required>

        <label>–î–∞—Ç–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è (YYYY-MM-DD):</label>
        <input type="date" name="transfer_date" value="{{ state.doc_date_xml or '' }}" required>

        <label>–ö–æ–º–ø–∞–Ω–∏—è:</label>
        <select name="vendor">
          <option value="SOTEX" selected>SOTEX</option>
          <option value="RAFARMA">RAFARMA</option>
        </select>

        {% if state.debug_mode %}
          <div class="muted">Debug-—Ä–µ–∂–∏–º –≤–∫–ª—é—á—ë–Ω: –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º –ø–æ—è–≤–∏—Ç—Å—è –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏ –º–æ–∂–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å JSON.</div>
        {% endif %}

        <button type="submit">–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å</button>
      </form>
    {% else %}
      <div class="msg err">‚ùå –ö–æ–¥—ã —Ä–∞–∑–ª–∏—á–∞—é—Ç—Å—è</div>
      {% if state.only_in_first and state.only_in_first|length %}
        <p><b>–¢–æ–ª—å–∫–æ –≤ –ø–µ—Ä–≤–æ–º XML:</b></p><div class="logs">{{ state.only_in_first | join('\n') }}</div>
      {% endif %}
      {% if state.only_in_second and state.only_in_second|length %}
        <p><b>–¢–æ–ª—å–∫–æ –≤–æ –≤—Ç–æ—Ä–æ–º XML:</b></p><div class="logs">{{ state.only_in_second | join('\n') }}</div>
      {% endif %}
    {% endif %}
  {% endif %}

  {% if state.flow_logs and state.flow_logs|length %}
    <h3>–ñ—É—Ä–Ω–∞–ª –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h3>
    <a href="{{ url_for('clear_logs') }}"><button>–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button></a>
    <table>
      <tr><th>–í—Ä–µ–º—è</th><th>–®–∞–≥</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th><th>–°—Ç–∞—Ç—É—Å</th><th>–°–æ–æ–±—â–µ–Ω–∏–µ</th></tr>
      {% for l in state.flow_logs %}
        <tr>
          <td>{{ l.time }}</td>
          <td>{{ l.step }}</td>
          <td>{{ l.action }}</td>
          <td>{{ l.status }}</td>
          <td>{{ l.message }}</td>
        </tr>
      {% endfor %}
    </table>
  {% endif %}
</div>

<script>
  document.querySelectorAll('.tabbtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tabbtn').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      btn.classList.add('active');
      document.querySelector(btn.dataset.target).classList.add('active');
    });
  });
</script>
<script>
  // --- —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏ –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞–º–∏ ---
  const tabButtons = document.querySelectorAll('.tabbtn');
  const tabs = document.querySelectorAll('.tab');

  // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  const savedTab = sessionStorage.getItem('activeTab');
  if (savedTab) {
    tabButtons.forEach(b => b.classList.remove('active'));
    tabs.forEach(t => t.classList.remove('active'));
    document.querySelector(`.tabbtn[data-target="${savedTab}"]`)?.classList.add('active');
    document.querySelector(savedTab)?.classList.add('active');
  }

  // –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      tabButtons.forEach(b => b.classList.remove('active'));
      tabs.forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      const target = btn.dataset.target;
      document.querySelector(target).classList.add('active');
      sessionStorage.setItem('activeTab', target);
    });
  });
</script>
</body>
</html>
